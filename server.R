server <- function(input, output, session) {
  
  # pop-up alert upon app start
  if (!(identical(readLines("text/alert_title.html"), character(0)) &
        identical(readLines("text/alert_title.html"), character(0)))) {
    shinyalert(
      title = readLines("text/alert_title.html"),
      text = readLines("text/alert_text.html"),
      type = "",
      html = TRUE,
      size = "s",
      closeOnClickOutside = TRUE,
      closeOnEsc = TRUE
    ) 
  }
  
  # check if dataset has been updated on GitHub and if so, download it and redeploy the app
  observe({
    
    ## run only if app is running on the server, not locally
    if (!is_local) {
      
      ### run every 5 minutes
      invalidateLater(1000 * 60 * 5, session)
      
      ### report run
      cat(paste("Checking for data update:", Sys.time()), fill = TRUE)
      
      ### read update_time.txt from GitHub repo
      new_time <- readLines("https://raw.githubusercontent.com/ccodwg/Covid19Canada/master/update_time.txt")
      
      ### check if update_time.txt is different from current version
      if (identical(new_time, update_time)) {
        cat("No data update required.", fill = TRUE)
      } else {
        cat("Updating data...", fill = TRUE)
        source("data_updater.R") # update data
        cat("Redeploying dashboard...", fill = TRUE)
        source("dashboard_redeploy.R") # redeploy dashboard
      } 
      
    }
    
  })
  
  # render sidebar
  output$sidebar_controls <- renderUI({
    if (input$tab %in% c(
      "tab_trends",
      "tab_maps",
      "tab_cases",
      "tab_mortality",
      "tab_recovered",
      "tab_testing",
      "tab_vaccines",
      "tab_travel"
    )) {
      list(
        selectInput(
          "prov",
          "Province",
          choices = c(
            "All provinces" = "Canada",
            "Alberta" = "Alberta",
            "British Columbia" = "BC",
            "Manitoba" = "Manitoba",
            "New Brunswick" = "New Brunswick",
            "Newfoundland and Labrador" = "NL",
            "Northwest Territories" = "NWT",
            "Nova Scotia" = "Nova Scotia",
            "Nunavut" = "Nunavut",
            "Ontario" = "Ontario",
            "Prince Edward Island" = "PEI",
            "Quebec" = "Quebec",
            "Saskatchewan" = "Saskatchewan",
            "Yukon" = "Yukon"
          )
        ),
        dateRangeInput(
          "date_range",
          "Date range",
          start = date_min,
          end = date_max,
          min = date_min,
          max = date_max,
          format = "yyyy/mm/dd"
        )
      )
    }
  })
  
  # return plot instructing the user no cases match their filter settings
  plot_no_data <- function(completely_blank = FALSE) {
    if (completely_blank) {
      ## select message
      m <- ""
    } else {
      m <-
        "No data match your filter settings.\nPlease try again with different settings."
    }
    
    ## produce blank plot w/ or w/out message
    plot_ly() %>%
      add_text(x = 0, y = 0, text = m, textfont = list(size = 25), textposition = "center") %>%
      layout(
        xaxis = axis_hide,
        yaxis = axis_hide,
        legend = plotly_legend
      ) %>%
      config(
        displaylogo = FALSE,
        modeBarButtonsToRemove = plotly_buttons
      )
  }
  
  # reactive data
  
  ## function: get and filter data
  get_data <- function(dataset, var_date, filter_province = ifelse(isTruthy(input[["prov"]]), input$prov, "Canada"), filter_date_lower = ifelse(isTruthy(input[["date_range"]]), input$date_range[1], date_min), filter_date_upper = ifelse(isTruthy(input[["date_range"]]), input$date_range[2], date_max), filter_province_ignore = FALSE, filter_date_ignore = FALSE) {
    get(dataset) %>%
      ### filter by province (if applicable)
      {if (!filter_province_ignore & filter_province != "Canada") filter(., province == filter_province) else .} %>%
      ### filter by date range (if applicable)
      {if (!filter_date_ignore) filter(., !!sym(var_date) >= filter_date_lower & !!sym(var_date) <= filter_date_upper) else .}
  }
  
  ## function: define comparison variable name
  get_var_comp <- function(var_val, comparison_window, comparison_scale) {
    if (comparison_scale == "per-capita") {
      if (comparison_window > 1) {
        paste(var_val, "per_100k", "avg", comparison_window, "day", sep = "_")
      } else {
        paste(var_val, "per_100k", sep = "_")
      }
    } else {
      if (comparison_window > 1) {
        paste(var_val, "avg", comparison_window, "day", sep = "_")
      } else {
        var_val
      }
    }
  }
  
  ## function: get and filter data for provincial comparisons
  get_data_comp <- function(dataset, var_date, var_val, comparison_window, comparison_scale) {
    
    ### ensure comparison_window is an integer
    comparison_window <- as.integer(comparison_window)
    
    ### comparison variable name
    var_comp <- get_var_comp(var_val, comparison_window, comparison_scale)
    
    ### calculate comparisons
    get_data(dataset, var_date, filter_province_ignore = TRUE, filter_date_ignore = TRUE) %>%
      filter(province != "Repatriated") %>%
      select(province_short, pop, !!sym(var_val)) %>%
      rename(!!sym(var_comp) := !!sym(var_val)) %>%
      group_by(province_short) %>%
      ### select only data from the window (e.g., most recent 7 days)
      slice_tail(n = comparison_window) %>%
      ### convert to per-capita (if applicable)
      {if (comparison_scale == "per-capita") mutate(., !!sym(var_comp) := !!sym(var_comp) / pop * 100000) else .} %>%
      summarize(pop = max(pop), !!sym(var_comp) := mean(!!sym(var_comp)), .groups = "drop")
  }
  
  ## cases
  data_cases <- reactive({
    get_data("cases", "date_report")
  })
  
  ## mortality
  data_mortality <- reactive({
    get_data("mortality", "date_death_report")
  })
  
  ## cases time series
  data_ts_cases <- reactive({
    get_data("ts_cases", "date_report")
  })
  
  ## mortality time series
  data_ts_mortality <- reactive({
    get_data("ts_mortality", "date_death_report")
  })
  
  ## recovered time series
  data_ts_recovered <- reactive({
    get_data("ts_recovered", "date_recovered")
  })
  
  ## testing time series
  data_ts_testing <- reactive({
    get_data("ts_testing", "date_testing")
  })
  
  ## vaccine administration time series
  data_ts_vaccine_administration <- reactive({
    get_data("ts_vaccine_administration", "date_vaccine_administered")
  })
  
  ## vaccine distribution time series
  data_ts_vaccine_distribution <- reactive({
    get_data("ts_vaccine_distribution", "date_vaccine_distributed")
  })
  
  ## vaccine distribution time series
  data_ts_vaccine_completion <- reactive({
    get_data("ts_vaccine_completion", "date_vaccine_completed")
  })
  
  ## case time series (health regions)
  data_ts_cases_hr <- reactive({
    get_data("ts_cases_hr", "date_report")
  })
  
  ## mortality time series (health regions)
  data_ts_mortality_hr <- reactive({
    get_data("ts_mortality_hr", "date_death_report")
  })
  
  ## case time series (health regions)
  data_ts_cases_new_hr <- reactive({
    get_data("ts_cases_new_hr", "date_report")
  })
  
  ## mortality time series (health regions)
  data_ts_mortality_new_hr <- reactive({
    get_data("ts_mortality_new_hr", "date_death_report")
  })
  
  ### add specific SK cumulative totals for back-dated data
  data_ts_cases_new_add_hr <- reactive({
    get_data("ts_cases_new_add_hr", "date_report")
  })
  
  ## mortality time series (health regions)
  data_ts_mortality_new_add_hr <- reactive({
    get_data("ts_mortality_new_add_hr", "date_death_report")
  })
  
  ## case time series (filter by date only for pie chart)
  data_ts_cases_pie <- reactive({
    get_data("ts_cases", "date_report", filter_province_ignore = TRUE)
  })
  
  ## mortality time series (filter by date only for pie chart)
  data_ts_mortality_pie <- reactive({
    get_data("ts_mortality", "date_death_report", filter_province_ignore = TRUE)
  })
  
  ## comparisons data cases
  data_comp_cases <- reactive({
    get_data_comp("ts_cases", "date_report", "cases", comparison_window = input$window_comp_cases, comparison_scale = input$scale_comp_cases)
  })
  
  ## comparisons data mortality
  data_comp_mortality <- reactive({
    get_data_comp("ts_mortality", "date_death_report", "deaths", comparison_window = input$window_comp_mortality, comparison_scale = input$scale_comp_mortality)
  })
  
  ## comparisons data testing
  data_comp_testing <- reactive({
    get_data_comp("ts_testing", "date_testing", "testing", comparison_window = input$window_comp_testing, comparison_scale = input$scale_comp_testing)
  })
  
  ## comparisons data testing
  data_comp_testing <- reactive({
    get_data_comp("ts_testing", "date_testing", "testing", comparison_window = input$window_comp_testing, comparison_scale = input$scale_comp_testing)
  })
  
  # render info tables
  
  ## info: testing
  output$table_info_testing <- renderDT({
    info_testing %>%
      datatable(
        class = "stripe compact hover",
        rownames = FALSE,
        escape = FALSE,
        options = list(
          paging = FALSE,
          scrollX = TRUE,
          compact = TRUE,
          autoWidth = TRUE
        )
      )
  })
  
  # summary numbers for overview tab
  
  ## function: summary numbers for overview tab
  value_box_summary <- function(table_overview, var_cum, var_update, lab_title, colour_box, update_type = c("new", "change"), val_cum_format = c("raw", "million"), font_size_update = "40%") {
    
    ### check update type (new or change +/-)
    match.arg(update_type, c("new", "change", several.ok = FALSE))
    
    ### check cumulative value format (raw or millions)
    match.arg(val_cum_format, c("raw", "million"), several.ok = FALSE)
    
    ### calculate values
    val_cum <- table_overview %>%
      filter(Province == "Canada") %>%
      pull(var_cum) %>%
      {
        if (val_cum_format == "raw") {
          formatC(., format = "f", digits = 0, big.mark = ",")
        } else if (val_cum_format == "million") {
          paste0(formatC(. / 1000000, digits = 2, format = "f", big.mark = ","), "m")
        }
      }
    val_update <- table_overview %>% filter(Province == "Canada") %>% pull(var_update)
    
    ### value box
    HTML(paste0(
      tags$p(val_cum, style = "font-size: 95%;"),
      "<div style='font-size:",
      font_size_update,
      "'>(",
      {if (update_type == "new") {
        paste0(
          format(val_update, big.mark = ","),
          " new)</div>"
        )
      } else {
        paste0(
          "Change: ",
          if (val_update >= 0) "+" else "",
          format(val_update, big.mark = ","),
          ")</div>"
        )}})) %>%
      valueBox(lab_title,
               color = colour_box)
  }
  
  ## cases
  output$value_box_summary_cases <- renderValueBox({
    value_box_summary(table_overview, "Cumulative cases", "Cases (new)", "Reported cases", "orange", update_type = "new", val_cum_format = "raw")
  })
  
  ## active cases
  output$value_box_summary_active <- renderValueBox({
    value_box_summary(table_overview, "Active cases", "Active cases (change)", "Active cases", "purple", update_type = "change", val_cum_format = "raw")
  })
  
  ## recovered
  output$value_box_summary_recovered <- renderValueBox({
    value_box_summary(table_overview, "Cumulative recovered", "Recovered (new)", "Total recovered", "light-blue", update_type = "new", val_cum_format = "raw")
  })
  
  ## mortality
  output$value_box_summary_mortality <- renderValueBox({
    value_box_summary(table_overview, "Cumulative deaths", "Deaths (new)", "Total deaths", "navy", update_type = "new", val_cum_format = "raw")
  })
  
  ## vaccine doses administered
  output$value_box_summary_doses_administered <- renderValueBox({
    value_box_summary(table_overview, "Cumulative vaccine doses administered", "Vaccine doses administered (new)", "Vaccine doses administered", "fuchsia", update_type = "new", val_cum_format = "million")
  })
  
  ## people fully vaccinated
  output$value_box_summary_fully_vaccinated <- renderValueBox({
    value_box_summary(table_overview, "Cumulative people fully vaccinated", "People fully vaccinated (new)", "People fully vaccinated", "aqua", update_type = "new", val_cum_format = "raw")
  })
  
  ## hospitalized
  output$value_box_summary_hosp <- renderValueBox({
    value_box_summary(table_overview, "Hospitalized", "Hospitalized (change)", "Hospitalized", "maroon", update_type = "change", val_cum_format = "raw")
  })
  
  ## testing
  output$value_box_summary_testing <- renderValueBox({
    value_box_summary(table_overview, "Cumulative testing", "Testing (new)", "Total testing", "olive", update_type = "new", val_cum_format = "million")
  })
  
  # title for province case map for overview tab
  output$title_choropleth_overview_cases <- renderText({
    
    ### don't run without inputs defined
    req(input$window_choropleth_overview_cases)
    
    ### render text
    paste("Reported cases by province/territory in the last", input$window_choropleth_overview_cases, "days")
  })
  
  # province case map for overview tab
  output$plot_choropleth_overview_cases <- renderPlotly({
    
    ### don't run without inputs defined
    req(input$window_choropleth_overview_cases)
    
    ### join provincial case numbers for relevant window to provincial map
    dat <- geo_prov_simple %>%
      left_join(
        data_ts_cases() %>%
          select(province_short, cases) %>%
          group_by(province_short) %>%
          slice_tail(n = input$window_choropleth_overview_cases) %>%
          summarize(cases = sum(cases), .groups = "drop"),
        by = "province_short"
      )
    
    ### even out colour scale by rooting case numbers
    dat <- dat %>%
      mutate(cases_colour = cases^(1/3))
    
    ### define value labels
    labs <- data.frame(
      province_short = dat[["province_short"]],
      x = as.numeric(st_coordinates(suppressWarnings((st_centroid(dat))))[, 1]),
      y = as.numeric(st_coordinates(suppressWarnings((st_centroid(dat))))[, 2]),
      lab_cases = format(dat[["cases"]], big.mark = ",", trim = TRUE),
      ### arrows for NS, NB, PE to avoid overlap
      show_arrow = ifelse(dat[["province_short"]] %in% c("NS", "NB", "PE"), TRUE, FALSE),
      arrow_x = as.numeric(st_coordinates(suppressWarnings((st_centroid(dat))))[, 1]),
      arrow_y = as.numeric(st_coordinates(suppressWarnings((st_centroid(dat))))[, 2]),
      stringsAsFactors = FALSE
    )
    
    ### manually nudge some label positions (x = label, ax = arrowhead tail)
    labs[labs$province_short == "AB", "y"] <- labs[labs$province_short == "AB", "y"] + 0.5
    labs[labs$province_short == "MB", "y"] <- labs[labs$province_short == "MB", "y"] + 0.5
    labs[labs$province_short == "ON", "y"] <- labs[labs$province_short == "ON", "y"] + 0.5
    labs[labs$province_short == "BC", "x"] <- labs[labs$province_short == "BC", "x"] + 0.5
    labs[labs$province_short == "BC", "y"] <- labs[labs$province_short == "BC", "y"] - 2.5
    labs[labs$province_short == "SK", "y"] <- labs[labs$province_short == "SK", "y"] - 2.5
    labs[labs$province_short == "NL", "x"] <- labs[labs$province_short == "NL", "x"] + 4
    labs[labs$province_short == "NL", "y"] <- labs[labs$province_short == "NL", "y"]
    labs[labs$province_short == "NU", "x"] <- labs[labs$province_short == "NU", "x"] - 7
    labs[labs$province_short == "NU", "y"] <- labs[labs$province_short == "NU", "y"] - 6
    labs[labs$province_short == "NT", "y"] <- labs[labs$province_short == "NT", "y"] - 2
    labs[labs$province_short == "YT", "y"] <- labs[labs$province_short == "YT", "y"] - 0.5
    labs[labs$province_short == "PE", "arrow_y"] <- labs[labs$province_short == "PE", "y"] + 3
    labs[labs$province_short == "NB", "arrow_x"] <- labs[labs$province_short == "NB", "x"] - 5
    labs[labs$province_short == "NS", "arrow_x"] <- labs[labs$province_short == "NS", "x"] + 7
    labs[labs$province_short == "NS", "arrow_y"] <- labs[labs$province_short == "NS", "y"] - 1
    
    ### plot data
    plot_ly() %>%
      add_sf(
        data = dat,
        type = "scatter",
        split = ~ province,
        color = ~ cases_colour,
        colors = "Reds",
        stroke = I("#000000"),
        span = I(1.5),
        hoverinfo = "none"
      ) %>%
      add_annotations(
        data = labs,
        x = ~ x,
        y = ~ y,
        text = ~ lab_cases,
        hoverinfo = "text",
        hovertext = paste0(labs$province_short, ": ", labs$lab_cases),
        font = list(color = "black", size = 14),
        bgcolor = "white",
        bordercolor = "black",
        showarrow = ~ show_arrow,
        ax = ~ arrow_x,
        ay = ~ arrow_y,
        axref = "x",
        ayref = "y"
      ) %>%
      layout(
        xaxis = axis_hide,
        yaxis = axis_hide,
        showlegend = FALSE
      ) %>%
      config(displaylogo = FALSE,
             ### hide all plotly buttons, since they do nothing here
             displayModeBar = FALSE) %>%
      hide_colorbar()
  })
  
  # render province case map for overview tab with dynamic width
  output$ui_plot_choropleth_overview_cases <- renderUI({
    
    ### don't run without inputs defined
    req(input$screen_width, input$window_choropleth_overview_cases)
    
    ### render plot
    fluidRow(
      column(
        h4(textOutput("title_choropleth_overview_cases")),
        plotlyOutput("plot_choropleth_overview_cases",
                     ### max width of plot = 600px
                     ### scale so plot doesn't overflow screen at small widths
                     width = ifelse(input$screen_width * (7/8) > 600, 600, input$screen_width * (7/8))),
        width = 12,
        align = "center"
      )
    )
  })
  
  # render province case map slider
  output$ui_window_choropleth_overview_cases <- renderUI({
    
    ### don't run without inputs defined
    req(input$screen_width)
    
    ### render UI
    fluidRow(
      column(
        sliderInput(
          "window_choropleth_overview_cases",
          "Show how many days?",
          min = 7,
          max = data_ts_cases() %>% pull(date_report) %>% unique %>% length,
          step = 1,
          value = 14
        ),
        width = 12,
        align = "center"
      )
    )
  })
  
  # title for province vaccine map for overview tab
  output$title_choropleth_overview_vaccine_administration <- renderText({
    
    ### don't run without inputs defined
    req(input$window_choropleth_overview_vaccine_administration)
    
    ### render text
    paste("Vaccine doses administered by province/territory in the last", input$window_choropleth_overview_vaccine_administration, "days")
  })
  
  # province vaccine administration map for overview tab
  output$plot_choropleth_overview_vaccine_administration <- renderPlotly({
    
    ### don't run without inputs defined
    req(input$window_choropleth_overview_vaccine_administration)
    
    ### join provincial vaccine numbers for relevant window to provincial map
    dat <- geo_prov_simple %>%
      left_join(
        data_ts_vaccine_administration() %>%
          select(province_short, avaccine) %>%
          group_by(province_short) %>%
          slice_tail(n = input$window_choropleth_overview_vaccine_administration) %>%
          summarize(avaccine = sum(avaccine), .groups = "drop"),
        by = "province_short"
      )
    
    ### even out colour scale by rooting vaccine numbers
    dat <- dat %>%
      mutate(cases_colour = avaccine^(1/3))
    
    ### define value labels
    labs <- data.frame(
      province_short = dat[["province_short"]],
      x = as.numeric(st_coordinates(suppressWarnings((st_centroid(dat))))[, 1]),
      y = as.numeric(st_coordinates(suppressWarnings((st_centroid(dat))))[, 2]),
      lab_cases = format(dat[["avaccine"]], big.mark = ",", trim = TRUE),
      ### arrows for NS, NB, PE to avoid overlap
      show_arrow = ifelse(dat[["province_short"]] %in% c("NS", "NB", "PE"), TRUE, FALSE),
      arrow_x = as.numeric(st_coordinates(suppressWarnings((st_centroid(dat))))[, 1]),
      arrow_y = as.numeric(st_coordinates(suppressWarnings((st_centroid(dat))))[, 2]),
      stringsAsFactors = FALSE
    )
    
    ### manually nudge some label positions (x = label, ax = arrowhead tail)
    labs[labs$province_short == "AB", "y"] <- labs[labs$province_short == "AB", "y"] + 0.5
    labs[labs$province_short == "MB", "y"] <- labs[labs$province_short == "MB", "y"] + 0.5
    labs[labs$province_short == "ON", "y"] <- labs[labs$province_short == "ON", "y"] + 0.5
    labs[labs$province_short == "BC", "x"] <- labs[labs$province_short == "BC", "x"] + 0.5
    labs[labs$province_short == "BC", "y"] <- labs[labs$province_short == "BC", "y"] - 2.5
    labs[labs$province_short == "SK", "y"] <- labs[labs$province_short == "SK", "y"] - 2.5
    labs[labs$province_short == "NL", "x"] <- labs[labs$province_short == "NL", "x"] + 4
    labs[labs$province_short == "NL", "y"] <- labs[labs$province_short == "NL", "y"]
    labs[labs$province_short == "NU", "x"] <- labs[labs$province_short == "NU", "x"] - 7
    labs[labs$province_short == "NU", "y"] <- labs[labs$province_short == "NU", "y"] - 6
    labs[labs$province_short == "NT", "y"] <- labs[labs$province_short == "NT", "y"] - 2
    labs[labs$province_short == "YT", "y"] <- labs[labs$province_short == "YT", "y"] - 0.5
    labs[labs$province_short == "PE", "arrow_y"] <- labs[labs$province_short == "PE", "y"] + 3
    labs[labs$province_short == "NB", "arrow_x"] <- labs[labs$province_short == "NB", "x"] - 5
    labs[labs$province_short == "NS", "arrow_x"] <- labs[labs$province_short == "NS", "x"] + 7
    labs[labs$province_short == "NS", "arrow_y"] <- labs[labs$province_short == "NS", "y"] - 1
    
    ### plot data
    plot_ly() %>%
      add_sf(
        data = dat,
        type = "scatter",
        split = ~ province,
        color = ~ cases_colour,
        colors = "Reds",
        stroke = I("#000000"),
        span = I(1.5),
        hoverinfo = "none"
      ) %>%
      add_annotations(
        data = labs,
        x = ~ x,
        y = ~ y,
        text = ~ lab_cases,
        hoverinfo = "text",
        hovertext = paste0(labs$province_short, ": ", labs$lab_cases),
        font = list(color = "black", size = 14),
        bgcolor = "white",
        bordercolor = "black",
        showarrow = ~ show_arrow,
        ax = ~ arrow_x,
        ay = ~ arrow_y,
        axref = "x",
        ayref = "y"
      ) %>%
      layout(
        xaxis = axis_hide,
        yaxis = axis_hide,
        showlegend = FALSE
      ) %>%
      config(displaylogo = FALSE,
             ### hide all plotly buttons, since they do nothing here
             displayModeBar = FALSE) %>%
      hide_colorbar()
  })
  
  # render province vaccine map for overview tab with dynamic width
  output$ui_plot_choropleth_overview_vaccine_administration <- renderUI({
    
    ### don't run without inputs defined
    req(input$screen_width, input$window_choropleth_overview_vaccine_administration)
    
    ### render plot
    fluidRow(
      column(
        h4(textOutput("title_choropleth_overview_vaccine_administration")),
        plotlyOutput("plot_choropleth_overview_vaccine_administration",
                     ### max width of plot = 600px
                     ### scale so plot doesn't overflow screen at small widths
                     width = ifelse(input$screen_width * (7/8) > 600, 600, input$screen_width * (7/8))),
        width = 12,
        align = "center"
      )
    )
  })
  
  # render province vaccine map slider
  output$ui_window_choropleth_overview_vaccine_administration <- renderUI({
    
    ### don't run without inputs defined
    req(input$screen_width)
    
    ### render UI
    fluidRow(
      column(
        sliderInput(
          "window_choropleth_overview_vaccine_administration",
          "Show how many days?",
          min = 7,
          max = data_ts_vaccine_administration() %>% pull(date_vaccine_administered) %>% unique %>% length,
          step = 1,
          value = data_ts_vaccine_administration() %>% pull(date_vaccine_administered) %>% unique %>% length
        ),
        width = 12,
        align = "center"
      )
    )
  })
  
  # province summary table for overview tab
  output$table_prov_overview <- renderDT({
    
    table_overview %>%
      ### show NA instead of 0 for "people fully vaccinated" (info not yet available)
      mutate(
        `Cumulative people fully vaccinated` = ifelse(`Cumulative people fully vaccinated` == 0, NA, `Cumulative people fully vaccinated`),
        `People fully vaccinated (new)` = ifelse(`Cumulative people fully vaccinated` == 0, NA, `People fully vaccinated (new)`)
      ) %>%
      ### merge short names
      left_join(map_prov %>% select(province, province_short),
                by = c("Province" = "province")) %>%
      mutate(Province = coalesce(province_short, Province)) %>%
      select(-province_short) %>%
      DT::datatable(class = "stripe compact hover", rownames = FALSE, extensions = "FixedColumns",
                    options = list(
                      paging = FALSE,
                      scrollX = TRUE,
                      compact = TRUE,
                      autoWidth = TRUE,
                      ### centre all but the first column
                      columnDefs = list(list(className = 'dt-center', targets = 1:(ncol(.) - 1))),
                      ### freeze province column
                      fixedColumns = list(leftColumns = 1)
                    )) %>%
      formatRound(columns = c("Cumulative cases", "Cases (new)", "Active cases", "Active cases (change)", "Cumulative vaccine doses administered", "Vaccine doses administered (new)", "Cumulative people fully vaccinated", "People fully vaccinated (new)", "Hospitalized", "Hospitalized (change)", "Cumulative deaths", "Deaths (new)", "Cumulative recovered", "Recovered (new)", "Cumulative testing", "Testing (new)"), digits = 0) %>%
      formatRound(columns = c("Cases (new) per 100k", "Cumulative cases per 100k", "Active cases per 100k", "Hospitalized per 100k", "Cumulative deaths per 100k"), digits = 1) %>%
      formatRound(columns = c("Cumulative testing per 100k"), digits = 0)
  })
  
  # flattening plots
  
  ## flattening interpretation
  output$text_flattening <- renderText({
    if (input$scale_flattening == "linear") {
      "<center><b>Interpretation</b><br>
  These graphs display trends for daily cases and deaths over time on a linear scale.
  <br><br>
  - An <i>upward slope</i> means the number of cases/deaths reported each day is <i>still growing</i>.
  <br>
  - A <i>flat line</i> means the number of cases/deaths reported each day is <i>staying the same</i>. 
  <br>
  - A <i>downward slope</i> means the number of cases/deaths reported each day is <i>falling</i>.</center>"
    } else if (input$scale_flattening == "logarithmic") {
      "<center><b>Interpretation</b><br>
  These graphs display trends for daily cases and deaths over time on a logarithmic scale.
  <br><br>
  - An <i>upward slope</i> means the number of cases/deaths reported each day is <i>still growing</i>.
  <br>
  - A <i>flat line</i> means the number of cases/deaths reported each day is <i>staying the same</i>. 
  <br>
  - A <i>downward slope</i> means the number of cases/deaths reported each day is <i>falling</i>.</center>"
    }
  })
  
  ## function: flattening plot title
  title_flattening <- function(lab_title, val_scale = input$scale_flattening) {
    
    ### don't run without inputs defined
    req(input$scale_flattening)
    
    ### render title
    if (val_scale == "linear") {
      paste0(lab_title, " (7-day rolling average)")
    } else if (val_scale == "logarithmic") {
      paste0(lab_title, " (7-day rolling average, logarithmic scale)")
    }
  }
  
  ## function: flattening plot
  plot_flattening <- function(fun_data, var_date, var_val, lab_y, val_scale = input$scale_flattening) {
    
    ### don't run without inputs defined
    req(input$scale_flattening)
    
    ### get data
    dat <- fun_data
    
    ### process data
    dat <- dat %>%
      filter(province != "Repatriated")
    
    ### calculate 7-day rolling average
    dat <- dat %>%
      group_by(province) %>%
      mutate(roll_avg = rollapply(!!sym(var_val), 7, mean, align = "right", partial = TRUE)) %>%
      ungroup
    
    ### plot data
    dat %>%
      plot_ly(
        x = as.formula(paste("~", var_date)),
        y = ~roll_avg,
        color = ~ province_short,
        colors = palette_province_short
      ) %>%
      add_lines() %>%
      rangeslider(start = update_date - months(3), end = update_date) %>%
      layout(
        xaxis = list(title = "Report date", fixedrange = TRUE, rangeslider = list(thickness = 0.1)),
        yaxis = {if (val_scale == "logarithmic") list(type = "log", title = lab_y, fixedrange = TRUE) else list(title = lab_y, fixedrange = TRUE)},
        legend = plotly_legend,
        showlegend = TRUE,
        hovermode = "x unified"
      ) %>%
      config(
        displaylogo = FALSE,
        modeBarButtonsToRemove = plotly_buttons
        )
  }
  
  ## cases
  output$title_flattening_cases <- renderText({title_flattening("Daily reported cases by province")})
  output$plot_flattening_cases <- renderPlotly({plot_flattening(data_ts_cases(), "date_report", "cases", "Daily reported cases")})
  
  ## mortality
  output$title_flattening_mortality <- renderText({title_flattening("Daily reported deaths by province")})
  output$plot_flattening_mortality <- renderPlotly({plot_flattening(data_ts_mortality(), "date_death_report", "deaths", "Daily reported deaths")})
  
  # comparisons
  
  ## function: comparisons plot title
  title_comp <- function(label_val, comparison_window, comparison_scale, date_max) {
    if (comparison_scale == "per-capita") {
      if (comparison_window > 1) {
        paste0("Average daily ", label_val, " per 100,000 (last ", comparison_window, " days)")
      } else {
        paste0(capitalize(label_val), " per 100,000 (", date_max, ")")
      }
    } else {
      if (comparison_window > 1) {
        paste0("Average daily ", label_val, " (last ", comparison_window, " days)")
      } else {
        paste0(capitalize(label_val), " (", date_max, ")")
      }
    }
  }
  
  ## function: comparisons plot
  plot_comp <- function(fun_data, var_val, comparison_window, comparison_scale, lab_y) {
    
    ### get comparison variable
    var_comp <- get_var_comp(var_val, comparison_window, comparison_scale)
    
    ### get data
    dat <- fun_data %>%
      ### create labels for values
      mutate(lab_comp = formatC(!!(sym(var_comp)), digits = 2, format = "f", big.mark = ","))
    
    ### add per-capita to y-axis label (if applicable)
    if (comparison_scale == "per-capita") {
      lab_y <- paste(lab_y, "per 100,000")
    }
    
    ### plot data
    dat %>%
      plot_ly() %>%
      add_trace(
        x = ~ province_short,
        y = as.formula(paste("~", var_comp)),
        type = "bar",
        color = ~ province_short,
        colors = palette_province_short,
        hoverinfo = "text",
        hovertext = paste0(
          dat[["province_short"]], ": ", dat[["lab_comp"]]
        )
      ) %>% 
      layout(
        xaxis = list(title = "Province", fixedrange = TRUE),
        yaxis = list(title = lab_y, fixedrange = TRUE),
        showlegend = FALSE
      ) %>%
      config(displaylogo = FALSE,
             modeBarButtonsToRemove = plotly_buttons)
    
  }
  
  # ## function: comparisons data download
  download_comp <- function(fun_data, file) {
    write.csv(fun_data, file, row.names = FALSE)
  }
  
  ## cases
  output$title_comp_cases <- renderText({
    title_comp("reported cases", input$window_comp_cases, input$scale_comp_cases, date_max)
  })
  
  # output$plot_comp_cases <- renderPlotly({
  #   plot_comp(data_comp_cases(), "cases", input$window_comp_cases, input$scale_comp_cases, "Daily reported cases")
  # })
  
  output$plot_comp_cases <- renderPlotly({
    plot_cumulative_v2(fun_data = data_comp_cases(), var_val = "cases", input_window = input$window_comp_cases, input_scale = input$scale_comp_cases, lab_y = "Daily reported cases", input_plot = "comparisons")
  })
  
  output$download_comp_cases <- downloadHandler(
    filename = "comp_prov_cases.csv",
    content = function(file) {
      download_comp(data_comp_cases(), file)
    }
  )
  
  ## mortality
  output$title_comp_mortality <- renderText({
    title_comp("reported deaths", input$window_comp_mortality, input$scale_comp_mortality, date_max)
  })
  output$plot_comp_mortality <- renderPlotly({
    plot_cumulative_v2(fun_data = data_comp_mortality(), var_val = "deaths", input_window = input$window_comp_mortality, input_scale = input$scale_comp_mortality, lab_y = "Daily reported mortality", input_plot = "comparisons")
    # plot_comp(data_comp_mortality(), "deaths", input$window_comp_mortality, input$scale_comp_mortality, "Daily reported mortality")
  })
  output$download_comp_mortality <- downloadHandler(
    filename = "comp_prov_mortality.csv",
    content = function(file) {
      download_comp(data_comp_mortality(), file)
    }
  )
  
  ## testing
  output$title_comp_testing <- renderText({
    title_comp("testing", input$window_comp_testing, input$scale_comp_testing, date_max)
  })
  output$plot_comp_testing <- renderPlotly({
    plot_cumulative_v2(fun_data = data_comp_testing(), var_val = "testing", input_window = input$window_comp_testing, input_scale = input$scale_comp_testing, lab_y = "Daily testing", input_plot = "comparisons")
    # plot_comp(data_comp_testing(), "testing", input$window_comp_testing, input$scale_comp_testing, "Daily testing")
  })
  output$download_comp_testing <- downloadHandler(
    filename = "comp_prov_testing.csv",
    content = function(file) {
      download_comp(data_comp_testing(), file)
    }
  )
  
  # maps tab
  
  ## load health region map
  load_geo_hr <- reactive({
    
    ### don't run without inputs defined
    req(input$date_range)
    
    if(input$date_range[1]=="2020/01/25" & input$date_range[2]>="2020/08/04") {
    st_read("geo/esri_health_region_sk_new/RegionalHealthBoundaries.shp", quiet = TRUE) %>%
      ### join health region names used in the dataset by HR_UID
      ### first convert HR_UID in map to integer so types match
      mutate(HR_UID = as.integer(HR_UID)) %>%
      inner_join(
        hr_map_sk_new,
        by = "HR_UID"
      )
    } else if (input$date_range[1]>="2020/08/04") {
        st_read("geo/esri_health_region_sk_new/RegionalHealthBoundaries.shp", quiet = TRUE) %>%
          ### join health region names used in the dataset by HR_UID
          ### first convert HR_UID in map to integer so types match
          mutate(HR_UID = as.integer(HR_UID)) %>%
          inner_join(
            hr_map_sk_new,
            by = "HR_UID"
          )
      } else if(input$date_range[1]=="2020/01/25" & input$date_range[2]<"2020/08/04") {
        st_read("geo/esri_health_region_sk_old/RegionalHealthBoundaries.shp", quiet = TRUE) %>%
          ### join health region names used in the dataset by HR_UID
          ### first convert HR_UID in map to integer so types match
          mutate(HR_UID = as.integer(HR_UID)) %>%
          inner_join(
            map_hr,
            by = "HR_UID"
          )
      } else if(input$date_range[1]!="2020/01/25" & input$date_range[1]<"2020/08/04") {
        st_read("geo/esri_health_region_sk_old/RegionalHealthBoundaries.shp", quiet = TRUE) %>%
          ### join health region names used in the dataset by HR_UID
          ### first convert HR_UID in map to integer so types match
          mutate(HR_UID = as.integer(HR_UID)) %>%
          inner_join(
            map_hr,
            by = "HR_UID"
          )
      }
  })
  
  ## health region map title
  output$title_choropleth_hr <- renderText({
    
    ### don't run without inputs defined
    req(input$metric_choropleth_hr, input$scale_choropleth_hr)
    
    ### render title
    if (input$metric_choropleth_hr == "cases") {
      if (input$scale_choropleth_hr == "absolute") {
        "Map of reported cases in Canada"
      } else if (input$scale_choropleth_hr == "per-capita") {
        "Map of reported cases in Canada (per 100,000)"
      }} else if (input$metric_choropleth_hr == "mortality") {
        if (input$scale_choropleth_hr == "absolute") {
          "Map of reported deaths in Canada"
        } else if (input$scale_choropleth_hr == "per-capita") {
          "Map of reported deaths in Canada (per 100,000)"
        }}
    
  })
  
  ## data: health region map
  data_choropleth_hr <- reactive({
    
    ### don't run without inputs defined
    req(input$metric_choropleth_hr, input$scale_choropleth_hr,input$date_range)

    ### get data
    
    if (input$metric_choropleth_hr == "cases") {
      if(input$date_range[1]=="2020/01/25" & input$date_range[2]>="2020/08/04") {
        dat <- data_ts_cases_new_add_hr() %>%
          left_join(
            hr_map_sk_new,
            by = c("province", "health_region")
          )
        var_val <- "cases"
      } else if(input$date_range[1]>="2020/08/04") {
        dat <- data_ts_cases_new_hr() %>%
          left_join(
            hr_map_sk_new,
            by = c("province", "health_region")
          )
        var_val <- "cases"
      } else if(input$date_range[1]=="2020/01/25" & input$date_range[2]<"2020/08/04") {
        dat <- data_ts_cases_hr() %>%
          left_join(
            map_hr,
            by = c("province", "health_region")
          )
        var_val <- "cases"
      } else if(input$date_range[1]!="2020/01/25" & input$date_range[1]<"2020/08/04") {
        dat <- data_ts_cases_hr() %>%
          left_join(
            map_hr,
            by = c("province", "health_region")
          )
        var_val <- "cases"
      }
    } else if(input$metric_choropleth_hr == "mortality") {
      if(input$date_range[1]=="2020/01/25" & input$date_range[2]>="2020/08/04") {
        dat <- data_ts_mortality_new_add_hr() %>%
          left_join(
            hr_map_sk_new,
            by = c("province", "health_region")
          )
        var_val <- "deaths"
      } else if(input$date_range[1]>="2020/08/04") {
        dat <- data_ts_mortality_new_hr() %>%
          left_join(
            hr_map_sk_new,
            by = c("province", "health_region")
          )
        var_val <- "deaths"
      } else if(input$date_range[1]=="2020/01/25" & input$date_range[2]<"2020/08/04") {
        dat <- data_ts_mortality_hr() %>%
          left_join(
            map_hr,
            by = c("province", "health_region")
          )
        var_val <- "deaths"
      }
      else if(input$date_range[1]!="2020/01/25" & input$date_range[1]<"2020/08/04") {
        dat <- data_ts_mortality_hr() %>%
          left_join(
            map_hr,
            by = c("province", "health_region")
          )
        var_val <- "deaths"
      }
    }
    
    ### process data
    dat %>%
      select(province, health_region, !!sym(var_val), pop) %>%
      group_by(province, health_region) %>%
      summarize(count := sum(!!sym(var_val)), pop = max(pop), .groups = "drop")
  })
  
  ## health region map
  output$choropleth_hr <- renderLeaflet({
    
    ### don't run without inputs defined
    req(input$metric_choropleth_hr, input$scale_choropleth_hr,input$date_range)
    
    ### load map
    geo_hr <- load_geo_hr()
    
    ### get data
    dat <- data_choropleth_hr() %>%
      ### exclude data where province == "Repatriated" or health_region == "Not Reported"
      filter(province != "Repatriated" & health_region != "Not Reported") %>%
      ### convert to per-capita (if applicable)
      {if (input$scale_choropleth_hr == "per-capita") mutate(., count = count / pop * 100000) else .}
    
    ### join data to map
    geo_hr <- geo_hr %>%
      left_join(
        dat,
        by = c("province", "health_region", "pop")
      )
    
    ### generate colour gradient (up to 5 bins)
    n_quantile <- 5
    probs <- seq(0, 1, length.out = n_quantile + 1)
    bins <- quantile(dat$count, probs, na.rm = TRUE, names = FALSE)
    ### ensure bins are integers for absolute scale
    if (input$scale_choropleth_hr == "absolute") {
      bins <- round(bins)
    }
    while (length(unique(bins)) != length(bins)) {
      n_quantile <- n_quantile - 1
      probs <- seq(0, 1, length.out = n_quantile + 1)
      bins <- quantile(dat$count, probs, na.rm = TRUE, names = FALSE)
      ### ensure bins are integers for absolute scale
      if (input$scale_choropleth_hr == "absolute") {
        bins <- round(bins)
      }
    }
    
    ## define bin colours
    if (input$metric_choropleth_hr == "cases") {
      gradient <- colorBin(brewer.pal(n = length(bins), "Blues"), bins = bins)
    } else if (input$metric_choropleth_hr == "mortality") {
      gradient <- colorBin(brewer.pal(n = length(bins), "Reds"), bins = bins)
    }
    
    ### render map
    leaflet(geo_hr) %>%
      addProviderTiles(providers$Stamen.TonerLite,
                       options = providerTileOptions(noWrap = TRUE, minZoom = 2, maxZoom = 8)) %>%
      addPolygons(
        stroke = TRUE,
        color = "black",
        opacity = 1,
        weight = 0.5,
        fillOpacity = 0.5,
        smoothFactor = 0.5,
        fillColor = ~gradient(count),
        popup =
          paste0(
            "<p>",
            "Province: ",
            geo_hr$province,
            "<br>",
            "Health Region: ",
            geo_hr$health_region,
            "<br>",
            "Population: ",
            formatC(geo_hr$pop, format = "f", big.mark = ",", digits = 0),
            "<br>",
            if (input$metric_choropleth_hr == "cases") {
              if (input$scale_choropleth_hr == "absolute") {
                "Reported cases: "
              } else if (input$scale_choropleth_hr == "per-capita") {
                "Reported cases (per 100,000): "
              }} else if (input$metric_choropleth_hr == "mortality") {
                if (input$scale_choropleth_hr == "absolute") {
                  "Reported deaths: "
                } else if (input$scale_choropleth_hr == "per-capita") {
                  "Reported deaths (per 100,000): "
                }},
            ### format numbers
            if (input$scale_choropleth_hr == "absolute") {
              ifelse(is.na(geo_hr$count), "0", formatC(geo_hr$count, format = "f", big.mark = ",", digits = 0))
            } else if (input$scale_choropleth_hr == "per-capita") {
              ifelse(is.na(geo_hr$count), "0", formatC(geo_hr$count, format = "f", big.mark = ",", digits = 2))
            },
            "</p>"
          )) %>%
      addLegend("bottomright", pal = gradient, values = ~count,
                title = {
                  if (input$metric_choropleth_hr == "cases") {
                    if (input$scale_choropleth_hr == "absolute") {
                      "Reported cases"
                    } else if (input$scale_choropleth_hr == "per-capita") {
                      "Reported cases</br>(per 100,000)"
                    }} else if (input$metric_choropleth_hr == "mortality") {
                      if (input$scale_choropleth_hr == "absolute") {
                        "Reported deaths"
                      } else if (input$scale_choropleth_hr == "per-capita") {
                        "Reported deaths</br>(per 100,000)"
                      }}
                },
                labFormat = labelFormat(prefix = "", suffix = "", between = " – ",
                                        digits = 2, big.mark = ",", transform = identity),
                na.label = "None reported",
                opacity = 0.5)
  })
  
  
  ## health region map text
  output$text_choropleth_hr <- renderText({
    
    ### don't run without inputs defined
    req(input$metric_choropleth_hr, input$scale_choropleth_hr,input$date_range)
    
    ### get data and only keep data where province == "Repatriated" or health_region == "Not Reported"
    dat <- data_choropleth_hr() %>%
      filter(province == "Repatriated" | health_region == "Not Reported")
    
    ### render text
    if (nrow(dat) == 0) {
      if (input$metric_choropleth_hr== "cases") {
        HTML("No cases were excluded from the map due to missing health region information.")
      } else if (input$metric_choropleth_hr == "mortality") {
        "No deaths were excluded from the map due to missing health region information."
      }
    } else {
      HTML(
        text = paste0(
          "We excluded ",
          if (input$metric_choropleth_hr == "cases") {
            "cases"
          } else if (input$metric_choropleth_hr == "mortality") {
            "deaths"
          },
          " from the map due to missing health region information:",
          "<ul>",
          paste("<li>", dat$province, ": ", dat$count, sep = "", collapse = ""),
          "</ul>")
      )
    }
  })
  
  # daily/cumulative numbers plots
  
  ## function: daily/cumulative numbers plot title
  title_daily_cumulative <- function(fun_data, var_date, var_val, lab_title, exclude_repatriated = FALSE, by_province = FALSE, filter_province = input$prov) {
    
    ### don't run without inputs defined
    req(input$prov, input$date_range)
    
    ### get data
    dat <- fun_data %>%
      ### remove repatriated cases from count (if applicable)
      {if (exclude_repatriated) filter(., province != "Repatriated") else .}
    
    ### calculate n
    n <- sum(dat[, var_val])
    
    ### render title
    if (n == 0) {
      paste0(lab_title, " in ", filter_province)
    } else {
      if (filter_province == "Canada" & by_province) {
        paste0(lab_title, " in ", filter_province, " by province (n = ", format(n, big.mark = ","), ")")
      } else {
        paste0(lab_title, " in ", filter_province, " (n = ", format(n, big.mark = ","), ")")
      }
    }
  }
  
  ## function: daily numbers plot
  plot_daily <- function(fun_data, var_date, var_val, lab_x, lab_y) {
    
    ### don't run without inputs defined
    req(input$prov, input$date_range)
    
    ### get data
    dat <- fun_data
    
    ### if no matching data, return blank plot
    if (sum(dat[, var_val]) == 0) {
      return(plot_no_data())
    }
    
    ### transform data
    dat <- dat %>%
      ### aggregate values so that one date = one row to ensure correct plotting of bars
      select(!!sym(var_date), !!sym(var_val)) %>%
      group_by(!!sym(var_date)) %>%
      summarize(!!sym(var_val) := sum(!!sym(var_val)), .groups = "drop") %>%
      ### calculate rolling average
      mutate(roll_avg = rollapply(!!sym(var_val), 7, mean, align = "right", partial = TRUE))
    
    ### plot data
    dat %>%
      plot_ly(x = as.formula(paste("~", var_date)),
              y = as.formula(paste("~", var_val))
      ) %>%
      add_bars(name = "Daily") %>%
      layout(
        xaxis = list(title = lab_x, fixedrange = TRUE),
        yaxis = list(title = lab_y, fixedrange = TRUE),
        legend = plotly_legend
      ) %>%
      add_lines(x = as.formula(paste("~", var_date)),
                y = ~roll_avg, name = "7-day average") %>%
      layout(yaxis2 = list(overlaying = "y", side = "right")) %>%
      layout(showlegend = TRUE,
             hovermode = "x unified"
      ) %>%
      config(displaylogo = FALSE,
             modeBarButtonsToRemove = plotly_buttons)
  }
  
  ## function: cumulative numbers plot
  plot_cumulative <- function(fun_data, var_date, var_val, lab_x, lab_y) {
    
    ### don't run without inputs defined
    ## INPUT_SCALE
    req(input$prov, input$date_range)
    
    ### get data
    dat <- fun_data
    
    ### if no matching data, return blank plot
    if (sum(dat[, var_val]) == 0) {
      return(plot_no_data())
    }
    
    ### transform data
    dat <- dat %>%
      filter(province != "Repatriated") %>%
      ### create labels for values
      mutate(lab_val = formatC(!!(sym(var_val)), big.mark = ","))
    
    ### plot data
    dat %>%
      plot_ly(
        x = as.formula(paste("~", var_date)),
        y = as.formula(paste("~", var_val)),
        color = ~ province_short,
        colors = palette_province_short,
        hoverinfo = "text",
        hovertext = paste0(
          "Province: ", dat[["province_short"]], "\n",
          "Date: ", dat[[var_date]], "\n",
          case_when(
            var_val == "cumulative_avaccine" ~ paste0("Cumulative vaccine doses administered: ", dat[["lab_val"]]),
            var_val == "cumulative_dvaccine" ~ paste0("Cumulative vaccine doses distributed: ", dat[["lab_val"]]),
            TRUE ~ paste0(capitalize(sub("_", " ", var_val)), ": ", dat[["lab_val"]])
          )
        )
      ) %>%
      add_lines() %>%
      layout(
        xaxis = list(title = lab_x, fixedrange = TRUE),
        yaxis = list(title = lab_y, fixedrange = TRUE),
        legend = plotly_legend
      ) %>%
      config(displaylogo = FALSE,
             modeBarButtonsToRemove = plotly_buttons)
  }
  
  ## daily numbers: cases
  output$title_daily_cases <- renderText({title_daily_cumulative(data_ts_cases(), "date_report", "cases", "Daily reported cases & 7-day rolling average")})
  output$plot_daily_cases <- renderPlotly({
    plot_daily(data_ts_cases(), "date_report", "cases", "Report date", "Daily reported cases")
  })
  
  ## daily numbers: mortality
  output$title_daily_mortality <- renderText({title_daily_cumulative(data_ts_mortality(), "date_death_report", "deaths", "Daily reported deaths & 7-day rolling average")})
  output$plot_daily_mortality <- renderPlotly({
    plot_daily(data_ts_mortality(), "date_death_report", "deaths", "Report date", "Daily reported deaths")
  })
  
  ## daily numbers: recovered
  output$title_daily_recovered <- renderText({title_daily_cumulative(data_ts_recovered(), "date_report", "recovered", "Daily recovered & 7-day rolling average")})
  output$plot_daily_recovered <- renderPlotly({
    plot_daily(data_ts_recovered(), "date_recovered", "recovered", "Date", "Daily recovered")
  })
  
  ## daily numbers: testing
  output$title_daily_testing <- renderText({title_daily_cumulative(data_ts_testing(), "date_testing", "testing", "Daily testing & 7-day rolling average")})
  output$plot_daily_testing <- renderPlotly({
    plot_daily(data_ts_testing(), "date_testing", "testing", "Date", "Daily testing")
  })
  
  ## daily numbers: vaccine administration
  output$title_daily_vaccine_administration <- renderText({title_daily_cumulative(data_ts_vaccine_administration(), "date_vaccine_administered", "avaccine", "Daily vaccine doses administered & 7-day rolling average")})
  output$plot_daily_vaccine_administration <- renderPlotly({
    plot_daily(data_ts_vaccine_administration(), "date_vaccine_administered", "avaccine", "Date", "Daily vaccine doses administered")
  })
  
  ## cumulative numbers: cases
  output$title_cumulative_cases <- renderText({
    # title_daily_cumulative(data_ts_cases(), "date_report", "cases", "Cumulative reported cases", exclude_repatriated = TRUE, by_province = TRUE)
    title_daily_cumulative_v2(data_ts_cases(), "date_report", "cases", "reported cases", input_scale = input$scale_cases, input_plot = input$plot_type_cases, exclude_repatriated = TRUE, by_province = TRUE)
    })
  output$plot_cumulative_cases <- renderPlotly({
    plot_cumulative_v2(data_ts_cases(), var_date = "date_report", var_val = "cumulative_cases", lab_x = "Report date", lab_y = "Cumulative reported cases", input_scale = input$scale_cases, input_plot = input$plot_type_cases)
    # plot_cumulative(data_ts_cases(), "date_report", "cumulative_cases", "Report date", "Cumulative reported cases")
  })
  
  ## cumulative numbers: mortality
  output$title_cumulative_mortality <- renderText({
    # title_daily_cumulative(data_ts_mortality(), "date_death_report", "deaths", "Cumulative reported deaths", exclude_repatriated = TRUE, by_province = TRUE)
    title_daily_cumulative_v2(data_ts_mortality(), "date_death_report", "deaths", "reported deaths", exclude_repatriated = TRUE, by_province = TRUE, input_scale = input$scale_deaths, input_plot = input$plot_type_deaths)
    })
  output$plot_cumulative_mortality <- renderPlotly({
    plot_cumulative_v2(data_ts_mortality(), var_date = "date_death_report", var_val = "cumulative_deaths", lab_x = "Date", lab_y = "Cumulative reported deaths", input_scale = input$scale_deaths, input_plot = input$plot_type_deaths)
    # plot_cumulative(data_ts_mortality(), "date_death_report", "cumulative_deaths", "Date", "Cumulative reported deaths")
  })
  
  ## cumulative numbers: recovered
  output$title_cumulative_recovered <- renderText({
    # title_daily_cumulative(data_ts_recovered(), "date_recovered", "recovered", "Cumulative recovered", exclude_repatriated = TRUE, by_province = TRUE)
    title_daily_cumulative_v2(data_ts_recovered(), "date_recovered", "recovered", "recovered", exclude_repatriated = TRUE, by_province = TRUE, input_scale = input$scale_recovered, input_plot = input$plot_type_recovered)
    })
  
    
  output$plot_cumulative_recovered <- renderPlotly({
    plot_cumulative_v2(data_ts_recovered(), var_date = "date_recovered", var_val = "cumulative_recovered", lab_x = "Date", lab_y = "Cumulative recovered", input_scale = input$scale_recovered, input_plot = input$plot_type_recovered)
    # plot_cumulative(data_ts_recovered(), "date_recovered", "cumulative_recovered", "Date", "Cumulative recovered")
  })
  
  ## cumulative numbers: testing
  output$title_cumulative_testing <- renderText({
    # title_daily_cumulative(data_ts_testing(), "date_testing", "testing", "Cumulative testing", exclude_repatriated = TRUE, by_province = TRUE)
    title_daily_cumulative_v2(data_ts_testing(), "date_testing", "testing", "testing", exclude_repatriated = TRUE, by_province = TRUE, input_scale = input$scale_testing, input_plot = input$plot_type_testing)
    })
  output$plot_cumulative_testing <- renderPlotly({
    plot_cumulative_v2(data_ts_testing(), var_date = "date_testing", var_val = "cumulative_testing", lab_x = "Date", lab_y = "Cumulative testing", input_scale = input$scale_testing, input_plot = input$plot_type_testing)
    # plot_cumulative(data_ts_testing(), "date_testing", "cumulative_testing", "Date", "Cumulative testing")
  })
  
  # pie charts
  
  ## function: pie chart plot title
  title_pie <- function(fun_data, var_val, lab_title) {
    
    ### don't run without inputs defined
    req(input$prov, input$date_range)
    
    ### get data
    n <- fun_data %>%
      filter(province != "Repatriated") %>%
      group_by(province_short) %>%
      ungroup %>%
      summarize(!!sym(var_val) := sum(!!sym(var_val)), .groups = "drop") %>%
      pull
    
    ### render title
    if (n == 0) {
      paste0("Pie chart of ", lab_title, " in Canada")
    } else {
      paste0("Pie chart of ", lab_title, " in Canada", " (n = ", format(n, big.mark = ","), ")")
    }
  }
  
  ## function: pie chart plot
  plot_pie <- function(fun_data, var_val) {
    
    ### don't run without inputs defined
    req(input$prov, input$date_range)
    
    ### get data
    dat <- fun_data
    
    ### if no matching data, return blank plot
    if (nrow(dat) == 0) {
      return(plot_no_data())
    }
    
    ### transform data and join colours
    dat <- dat %>%
      filter(province != "Repatriated") %>%
      group_by(province_short) %>%
      summarize(!!sym(var_val) := sum(!!sym(var_val)), .groups = "drop") %>%
      filter(!!sym(var_val) > 0) %>%
      left_join(
        data.frame(
          province_short = names(palette_province_short),
          colour_code = palette_province_short,
          stringsAsFactors = FALSE
        ),
        by = "province_short"
      ) %>%
      ### create labels
      mutate(
        lab_val = formatC(!!sym(var_val), big.mark = ","),
        lab_percent = paste0(formatC(!!sym(var_val) / sum(.[, var_val]) * 100, format = "f", digit = 2), "%")
      )
    
    ### plot data
    dat %>%
      plot_ly(
        labels = ~ province_short,
        values = as.formula(paste("~", var_val)),
        sort = TRUE,
        type = "pie",
        direction = "counterclockwise",
        textposition = "inside",
        marker = list(colors = ~ colour_code),
        textinfo = "text",
        text = ~ lab_percent,
        hoverinfo = "text",
        hovertext = ~ paste0(
          "Province: ", dat$province_short, "\n",
          capitalize(var_val), ": ", dat$lab_val, "\n",
          "Percent of total: ", dat$lab_percent
        )
      ) %>%
      layout(
        xaxis = axis_hide,
        yaxis = axis_hide,
        legend = plotly_legend
      ) %>%
      config(displaylogo = FALSE,
             modeBarButtonsToRemove = plotly_buttons)
  }
  
  ## cases
  output$title_pie_cases <- renderText({
    title_pie(data_ts_cases_pie(), "cases", "reported cases")
  })
  output$plot_pie_cases <- renderPlotly({
    plot_pie(data_ts_cases_pie(), "cases")
  })
  
  ## mortality
  output$title_pie_mortality <- renderText({
    title_pie(data_ts_mortality_pie(), "deaths", "reported deaths")
  })
  output$plot_pie_mortality <- renderPlotly({
    plot_pie(data_ts_mortality_pie(), "deaths")
  })
  
  # demographics plots
  
  ## function: demographics plot title
  title_demographics <- function(fun_data, lab_title, filter_province = input$prov) {
    
    ### don't run without inputs defined
    req(input$prov, input$date_range)
    
    ### get data
    dat <- fun_data %>%
      ### filter out data with no demographic info
      filter(!(age == "NR" & sex == "Not Reported"))
    
    ### calculate n
    n <- nrow(dat)
    
    ### render title
    if (n == 0) {
      paste0("Demographics of ", lab_title, " in ", filter_province)
    } else {
      paste0("Demographics of ", lab_title, " in ", filter_province, " (n = ", format(n, big.mark = ","), " with demographic data)")
    }
  }
  
  ## function: demographics plot
  plot_demographics <- function(fun_data, lab_y) {
    
    ### don't run without inputs defined
    req(input$prov, input$date_range)
    
    ### get data
    dat <- fun_data
    
    ### if no matching data, return blank plot
    if (nrow(dat) == 0) {
      return(plot_no_data())
    }
    
    ### transform data
    dat <- dat %>%
      select(age, sex) %>%
      group_by(age, sex) %>%
      summarize(count = n(), .groups = "drop")
    
    ### note if the data has no sex information
    ### if so, show not reported sex by default (is off by default otherwise)
    no_demo_info <- ifelse(identical(
      sum(dat %>% pull(count)),
      sum(dat %>% filter(sex == "Not Reported") %>% pull(count))
    ), TRUE, FALSE)
    
    ### prepare data for plotting
    dat <- dat %>%
      pivot_wider(names_from = sex,
                  values_from = count,
                  values_fill = 0)
    
    ### plot data
    dat %>%
      plot_ly() %>%
      {
        if ("Male" %in% names(dat))
          add_trace(
            .,
            x = ~ age,
            y = ~ Male,
            type = "bar",
            name = "Male",
            hoverinfo = "text",
            hovertext = paste0(
              "Sex: Male\n",
              "Age group: ", ifelse(as.character(dat[["age"]]) == "NR", "Not reported", as.character(dat[["age"]])), "\n",
              "Count: ", formatC(dat[["Male"]], big.mark = ",")
            )
          )
        else .
      } %>%
      {
        if ("Female" %in% names(dat))
          add_trace(.,
                    x = ~ age,
                    y = ~ Female,
                    type = "bar",
                    name = "Female",
                    hoverinfo = "text",
                    hovertext = paste0(
                      "Sex: Female\n",
                      "Age group: ", ifelse(as.character(dat[["age"]]) == "NR", "Not reported", as.character(dat[["age"]])), "\n",
                      "Count: ", formatC(dat[["Female"]], big.mark = ",")
                    )
          )
        else .
      }  %>%
      {
        if ("Not Reported" %in% names(dat))
          add_trace(
            .,
            x = ~ age,
            y = ~ `Not Reported`,
            type = "bar",
            name = "Not reported",
            hoverinfo = "text",
            hovertext = paste0(
              "Sex: Not reported\n",
              "Age group: ", ifelse(as.character(dat[["age"]]) == "NR", "Not reported", as.character(dat[["age"]])), "\n",
              "Count: ", formatC(dat[["Not Reported"]], big.mark = ",")
            ),
            marker = list(color = "rgb(128, 128, 128)"),
            visible = ifelse(no_demo_info, TRUE, "legendonly")
          )
        else .
      } %>% 
      layout(
        xaxis = list(title = "Age group", fixedrange = TRUE),
        yaxis = list(title = lab_y, fixedrange = TRUE),
        legend = plotly_legend
      ) %>%
      config(displaylogo = FALSE,
             modeBarButtonsToRemove = plotly_buttons)
    
  }
  
  ## cases
  output$title_demographics_cases <- renderText({
    title_demographics(data_cases(), "reported cases")
  })
  output$plot_demographics_cases <- renderPlotly({
    plot_demographics(data_cases(), "Reported cases")
  })
  
  ## mortality
  output$title_demographics_mortality <- renderText({
    title_demographics(data_mortality(), "reported deaths")
  })
  output$plot_demographics_mortality <- renderPlotly({
    plot_demographics(data_mortality(), "Reported deaths")
  })
  
  # vaccine tab-specific plots
  
  ## vaccine gap data
  data_vaccine_gap <- reactive({
    
    ### don't run without inputs defined
    req(input$prov, input$date_range)
    
    ### merge data
    dat <- full_join(
      data_ts_vaccine_administration() %>%
        rename(date_vaccine = date_vaccine_administered) %>%
        select(province, date_vaccine, cumulative_avaccine),
      data_ts_vaccine_distribution() %>%
        rename(date_vaccine = date_vaccine_distributed) %>%
        select(province, date_vaccine, cumulative_dvaccine),
      by = c("province", "date_vaccine")
    ) %>%
      replace_na(list(cumulative_avaccine = 0)) # 2020-12-13 is NA for avaccine
    
    ### collapse observations into one row per date
    dat %>%
      select(date_vaccine, cumulative_dvaccine, cumulative_avaccine) %>%
      group_by(date_vaccine) %>%
      summarize(across(everything(), sum), .groups = "drop")
    
  })
  
  ## vaccine gap title
  output$title_vaccine_gap <- renderText({
    
    ### don't run without inputs defined
    req(input$prov)
    
    if (input$prov != "all") {
      paste("Vaccine gap in", input$prov)
    } else {
      "Vaccine gap in Canada"
    }
    
  })
  
  ## vaccine gap plot
  output$plot_vaccine_gap <- renderPlotly({
    
    ### don't run without inputs defined
    req(input$prov, input$date_range)
    
    ### get merged vaccine data
    dat <- data_vaccine_gap()
    
    ### plot
    dat %>%
      plot_ly(
        x = ~date_vaccine, 
        y = ~cumulative_avaccine, 
        name = "Administered", 
        type = "scatter",
        mode = "none",
        fill = "tozeroy",
        fillcolor = "rgba(0, 0, 255, 0.3)"
      ) %>%
      add_trace(y = ~cumulative_dvaccine, 
                name = "Distributed",
                fill = "tonexty",
                fillcolor = "rgba(0, 0, 0, 0.7)"
      ) %>%
      layout(
        xaxis = list(title = "Date", fixedrange = TRUE, showgrid = FALSE),
        yaxis = list(title = "Vaccine doses", fixedrange = TRUE),
        legend = plotly_legend,
        hovermode = "x unified"
      ) %>%
      config(displaylogo = FALSE,
             modeBarButtonsToRemove = plotly_buttons)
    
  })
  
  ## percent fully vaccinated data
  data_fully_vaccinated <- reactive({
    
    ### don't run without inputs defined
    req(input$prov, input$date_range)
    
    ### merge data
    dat <- full_join(
      data_ts_vaccine_completion() %>%
        rename(date_vaccine = date_vaccine_completed) %>%
        select(province, date_vaccine, cumulative_cvaccine),
      data_ts_vaccine_administration() %>%
        rename(date_vaccine = date_vaccine_administered) %>%
        select(province, date_vaccine, cumulative_avaccine),
      by = c("province", "date_vaccine")
    ) %>%
      replace_na(list(cumulative_avaccine = 0,
                      cumulative_cvaccine = 0)) # 2020-12-13 is NA for avaccine
    
    ### collapse observations into one row per date
    dat %>%
      ### merge short names
      left_join(map_prov %>% select(province, province_short, pop),
                by = c("province")) %>% 
      select(date_vaccine, pop, cumulative_cvaccine, province_short) %>%
      group_by(date_vaccine, province_short) %>%
      summarize(across(everything(), sum), .groups = "drop") %>% 
      mutate(
        full_vaxx = 100 * cumulative_cvaccine / pop,
        lab_percent = paste0(formatC(full_vaxx, format = "f", digit = 2), "%")
      ) %>% 
      ungroup() %>% 
      group_by(province_short) %>% 
      filter(date_vaccine == max(date_vaccine))
    
  })
  
  ## percent fully vaccinated title
  output$title_fully_vaccinated <- renderText({
    
    ### don't run without inputs defined
    req(input$prov)
    
    if (input$prov != "all") {
      paste("Percent fully vaccinated in", input$prov)
    } else {
      "Percent fully vaccinated in Canada"
    }
    
  })
  
  ## percent fully vaccinated plot
  output$plot_fully_vaccinated <- renderPlotly({
    
    ### don't run without inputs defined
    req(input$prov, input$date_range)
    
    ### get merged vaccine data
    dat <- data_fully_vaccinated()
    
    ### plot data
    dat %>%
      plot_ly() %>%
      add_trace(
        x = ~ province_short,
        y = ~ full_vaxx,
        type = "bar",
        color = ~ province_short,
        colors = palette_province_short,
        hoverinfo = "text",
        hovertext = ~ paste0(
          "Province: ", dat$province_short, "\n",
          "Fully vaccinated", ": ", dat$cumulative_cvaccine, "\n",
          "Percent of total population: ", dat$lab_percent
        )
      ) %>% 
      layout(
        xaxis = list(title = "Province", fixedrange = TRUE),
        yaxis = list(title = "Percent", fixedrange = TRUE),
        showlegend = FALSE
      ) %>%
      config(displaylogo = FALSE,
             modeBarButtonsToRemove = plotly_buttons)
    
  })
  
  ## function: title cumulative
  
  ## function: comparisons plot title
  title_daily_cumulative_v2 <- function(fun_data, var_date, var_val, lab_title, input_scale, input_plot, exclude_repatriated = FALSE, by_province = FALSE, filter_province = input$prov) {
    
    ### don't run without inputs defined
    req(input$prov, input$date_range)
    
    ### get data
    dat <- fun_data %>%
      ### remove repatriated cases from count (if applicable)
      {if (exclude_repatriated) filter(., province != "Repatriated") else .}
    
    ### calculate n
    n <- sum(dat[, var_val])
    
    if (input_scale == "per-capita") {
      lab_title <- paste0(capitalize(lab_title), " per 100,000")
    }
    
    ### render title
    if (n == 0) {
      
      paste0(lab_title, " in ", filter_province)
      
    } else if (input_plot == "bar-graph") {
      
      if (input_scale == "per-capita") {
        lab_title <- paste0("Average ", tolower(lab_title))
      }
      
      if (filter_province == "Canada" & by_province) {
        paste0(capitalize(lab_title), " in ", filter_province, " by province (n = ", format(n, big.mark = ","), ")")
      } else {
        paste0(capitalize(lab_title), " in ", filter_province, " (n = ", format(n, big.mark = ","), ")")
      }

    } else if (input_plot == "time-series") {
      
      if (filter_province == "Canada" & by_province) {
        paste0("Cumulative ", tolower(lab_title), " in ", filter_province, " by province (n = ", format(n, big.mark = ","), ")")
      } else {
        paste0("Cumulative ", tolower(lab_title), " in ", filter_province, " (n = ", format(n, big.mark = ","), ")")
      }
      
    }

  }
  
  ## plot_cumulative_v2 function
  
  plot_cumulative_v2 <- function(fun_data, var_date, var_val, 
                                 input_scale, input_window, input_plot, 
                                 lab_x, lab_y) {
    
    ### get data
    dat <- fun_data
    
    # input_plot accepts input$plot_type
    if (input_plot == "bar-graph") {
      
      dat <- get_var_vaccine(fun_data, var_date, var_val, comparison_scale = input_scale)
      
      lab_y_var <- paste0("lab_", var_val)
      
      if (input_scale == "per-capita") {
        
        lab_y <- case_when(
          var_val == "cumulative_avaccine" ~ "Vaccine doses administered per 100,000",
          var_val == "cumulative_dvaccine" ~ "Vaccine doses distributed per 100,000",
          TRUE ~ ""
        )
        y_var <- paste0(var_val, "_per_capita")
        
      } else {
        lab_y <- case_when(
          var_val == "cumulative_avaccine" ~ "Cumulative vaccine doses administered",
          var_val == "cumulative_dvaccine" ~ "Cumulative vaccine doses distributed",
          TRUE ~ ""
        )
        y_var <- var_val
      }
      
      ### plot data
      dat %>%
        plot_ly() %>%
        add_trace(
          x = ~ province_short,
          y = as.formula(paste("~", y_var)),
          type = "bar",
          color = ~ province_short,
          colors = palette_province_short,
          hoverinfo = "text",
          hovertext = paste0(
            dat$province_short, ": ", dat[[lab_y_var]]
          )
        ) %>% 
        layout(
          xaxis = list(title = "Province", fixedrange = TRUE),
          yaxis = list(title = lab_y, fixedrange = TRUE),
          showlegend = FALSE
        ) %>%
        config(displaylogo = FALSE,
               modeBarButtonsToRemove = plotly_buttons)
      
    } else if (input_plot == "time-series") {
      
      if (input_scale == "per-capita") {
        
        dat <- dat %>% 
          group_by(province_short) %>% 
          mutate(!!sym(var_val) := !!sym(var_val) / pop * 100000) %>% 
          ungroup()
        
      } 
      
      lab_y <- case_when(
        var_val == "cumulative_avaccine" ~ "Cumulative vaccine doses administered",
        var_val == "cumulative_dvaccine" ~ "Cumulative vaccine doses distributed",
        TRUE ~ paste0(capitalize(sub("_", " ", var_val)), ": ")
      )
      
      ### transform data
      dat <- dat %>%
        filter(province != "Repatriated") %>%
        ### create labels for values
        mutate(lab_val = formatC(!!(sym(var_val)), big.mark = ","))
      
      ### plot data
      dat %>%
        plot_ly(
          x = as.formula(paste("~", var_date)),
          y = as.formula(paste("~", var_val)),
          color = ~ province_short,
          colors = palette_province_short
        ) %>%
        add_lines() %>%
        layout(
          xaxis = list(title = lab_x, fixedrange = TRUE),
          yaxis = list(title = lab_y, fixedrange = TRUE),
          hovermode = "x unified",
          legend = plotly_legend
        ) %>%
        config(displaylogo = FALSE,
               modeBarButtonsToRemove = plotly_buttons)
      
    } else if (input_plot == "comparisons") {
      
      # Run plot_comp
      plot_comp(fun_data, var_val, input_window, input_scale, lab_y)
      
    } else {
      
      ### if no matching data, return blank plot
      if (sum(dat[, var_val]) == 0) {
        return(plot_no_data())
      }
      
    }
    
  }
  
  ## doses administered by province (absolute/per-capita) data
  
  get_var_vaccine <- function(fun_data, var_date, var_val, comparison_scale) {
    
    dat <- fun_data
    
    ### convert to per-capita (if applicable)
    if (comparison_scale == "per-capita") {
      
      var_comp <- paste0(var_val, "_per_capita")
      lab_var_comp <- paste0("lab_", var_val)
      
      dat %>% 
        # left_join(map_prov %>% select(province, pop), by = c("province")) %>% 
        group_by(province) %>% 
        ### convert to per-capita (if applicable)
        filter(!!sym(var_date) == max(!!sym(var_date))) %>% 
        ungroup() %>% 
        dplyr::mutate(!!sym(var_comp) := !!sym(var_val) / pop * 100000) %>%
        ### create labels for values
        dplyr::mutate(!!sym(lab_var_comp) := formatC(!!sym(var_comp), digits = 2, format = "f", big.mark = ",")) 
      ### merge short names
      # left_join(map_prov %>% select(province, province_short), by = c("province"))
      
    } else {
      
      var_comp <- var_val
      lab_var_comp <- paste0("lab_", var_val)
      
      dat %>% 
        group_by(province) %>% 
        ### convert to per-capita (if applicable)
        filter(!!sym(var_date) == max(!!sym(var_date))) %>% 
        summarize(pop = max(pop), 
                  !!sym(var_comp) := mean(!!sym(var_val)), .groups = "drop") %>% 
        ### create labels for values
        dplyr::mutate(!!sym(lab_var_comp) := formatC(!!sym(var_comp), digits = 2, format = "f", big.mark = ",")) %>% 
        ### merge short names
        left_join(map_prov %>% select(province, province_short), by = c("province"))
      
    }
    
  }
  
  
  data_avaccine_per_capita <- reactive({
    get_var_vaccine(data_ts_vaccine_administration(), "date_vaccine_administered", "cumulative_avaccine", comparison_scale = input$scale_comp_avacc)
  })
  
  ## doses administered by province (absolute/per-capita) title
  
  output$title_avaccine_per_capita <- renderText({
    
    title_daily_cumulative_v2(data_ts_vaccine_administration(), "date_vaccine_administered", "cumulative_avaccine", "doses administered", input_scale = input$scale_comp_avacc, input_plot = input$plot_type_avacc, exclude_repatriated = TRUE, by_province = TRUE)
  
  })
  
  ## doses administered by province (absolute/per-capita) plot
  
  output$plot_avaccine_per_capita <- renderPlotly({
    
    plot_cumulative_v2(
      data_ts_vaccine_administration(),
      var_val = "cumulative_avaccine", 
      var_date = "date_vaccine_administered",
      input_scale = input$scale_comp_avacc, 
      input_plot = input$plot_type_avacc, 
      lab_x = "Province"
    )
    
  })
  
  ## doses distributed by province (absolute/per-capita) data
  
  data_dvaccine_per_capita <- reactive({
    get_var_vaccine(data_ts_vaccine_distribution(), "date_vaccine_distributed", "cumulative_dvaccine", input$scale_comp_dvacc)
  })
  
  ## doses distributed by province (absolute/per-capita) title
  
  output$title_dvaccine_per_capita <- renderText({
    
      title_daily_cumulative_v2(data_ts_vaccine_distribution(), "date_vaccine_distributed", "cumulative_dvaccine", "doses distributed", input_scale = input$scale_comp_dvacc, input_plot = input$plot_type_dvacc, exclude_repatriated = TRUE, by_province = TRUE)
    
  })
  
  ## doses distributed by province (absolute/per-capita) plot
  
  output$plot_dvaccine_per_capita <- renderPlotly({
    
    plot_cumulative_v2(
      data_ts_vaccine_distribution(),
      var_val = "cumulative_dvaccine", 
      var_date = "date_vaccine_distributed",
      input_scale = input$scale_comp_dvacc, 
      input_plot = input$plot_type_dvacc, 
      lab_x = "Province"
    )
    
  })
  
  # summary table for time to percent vaccinated by province
  
  output$table_prov_time_to_pct_vaccination <- renderDT({
    
    req(input$prov, input$date_range, input$pct_vaccination)
    
    ## create dataframe by province
    table_time_to_pct_vaccination <- data_ts_vaccine_administration() %>% 
      select(date_vaccine_administered, avaccine, cumulative_avaccine, province) %>%
      dplyr::group_by(date_vaccine_administered, province) %>% 
      dplyr::summarize(
        avaccine = sum(avaccine),
        cumulative_avaccine = sum(cumulative_avaccine),
        .groups = "drop") %>%
      ungroup() %>% 
      mutate(province = as.factor(province)) %>% 
      group_by(province) %>% 
      dplyr::mutate(roll_avg = rollapply(avaccine, 7, mean, align = "right", partial = TRUE)) %>% 
      arrange(date_vaccine_administered) %>% 
      dplyr::mutate(
        current_cum = last(cumulative_avaccine)
      ) %>% 
      filter(date_vaccine_administered == max(date_vaccine_administered)) %>% 
      ungroup() %>% 
      left_join(map_prov, by = "province") %>% 
      dplyr::mutate(
        total_needed = (input$pct_vaccination/100) * 2 * pop,
        date_to_vaxx = max(date_vaccine_administered) + round((total_needed - current_cum) / roll_avg, 0),
        days_to_vaxx = date_to_vaxx - date_vaccine_administered,
        weeks_to_vaxx = as.numeric(days_to_vaxx) / 7,
        mths_to_vaxx = as.numeric(days_to_vaxx) / 12
      ) %>% 
      mutate_if(is.numeric, round, 1) %>% 
      mutate(
        roll_avg_lab = formatC(roll_avg, digits = 1, format = "f", big.mark = ","),
        pop_lab = formatC(pop, digits = 0, format = "f", big.mark = ","),
        current_cum_lab = formatC(current_cum, digits = 0, format = "f", big.mark = ","),
        total_needed_lab = formatC(total_needed, digits = 0, format = "f", big.mark = ",")
      ) %>% 
      select(province, pop_lab, current_cum_lab, roll_avg_lab, total_needed_lab, date_to_vaxx) %>% 
      dplyr::rename(
        "Province" = province,
        "Population" = pop_lab,
        "Total doses administered" = current_cum_lab,
        "7-day rolling average of doses administered" = roll_avg_lab,
        "Remaining doses needed<sup> a</sup>" = total_needed_lab,
        !!paste0("Expected date to reach ", input$pct_vaccination, "% fully vaccinated", "<sup> b</sup>") := date_to_vaxx)
    
    table_time_to_pct_vaccination %>%
      DT::datatable(class = "stripe compact hover", 
                    rownames = FALSE, 
                    extensions = "FixedColumns",
                    escape = FALSE,
                    caption = tags$caption(
                      style = "caption-side: bottom; text-align: left; margin: 8px 0;",
                      p(tags$sup("a "), paste0("Assuming ", input$pct_vaccination, "% of the population receives 2 vaccine doses.")),
                      p(tags$sup("b "), "The expected date column is calculated based on the 7-day average rate of daily vaccine doses administered and assumes that every individual receives 2 doses. This calculation does not account for delays between doses.")
                    ),
                    options = list(
                      dom = "t",
                      paging = FALSE,
                      scrollX = FALSE,
                      compact = TRUE,
                      autoWidth = TRUE,
                      ### centre all but the first column
                      columnDefs = list(list(className = 'dt-center', targets = 1:(ncol(.) - 1))),
                      ### freeze province column
                      fixedColumns = list(leftColumns = 1:(ncol(.) - 1))
                    ))
    
  })
  
}
